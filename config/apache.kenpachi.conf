PassengerDefaultUser httpd

<VirtualHost 216.245.200.162:80>
	ServerName gamersmafia.com
	DocumentRoot /srv/www/gamersmafia/current/public

	#LimitRequestBody 100000000

	ErrorDocument 500 /500.html
	ErrorDocument 501 /503.html
	ErrorDocument 502 /503.html
	ErrorDocument 503 /503.html

	<Directory "/srv/www/gamersmafia/current/public">
		Options FollowSymLinks
		AllowOverride None
		Order allow,deny
		Allow from all
	</Directory>

	AddDefaultCharset UTF-8


	# PASSENGER CONFIG
	# PassengerMaxPoolSize 9
	PassengerStatThrottleRate 4
	RailsFrameworkSpawnerIdleTime 0
	RailsAppSpawnerIdleTime 0
	PassengerMaxRequests 10000
	# PassengerUseGlobalQueue on
	RewriteEngine On

	# GZIP (deflate)
	AddOutputFilterByType DEFLATE text/html text/plain text/css text/xml application/xml application/xhtml+xml text/javascript application/x-javascript application/javascript
	BrowserMatch ^Mozilla/4 gzip-only-text/html
	BrowserMatch ^Mozilla/4.0[678] no-gzip
	BrowserMatch \bMSIE !no-gzip !gzip-only-text/html

	SetEnvIf Status 304 notmodified
	#SetEnvIf ^X-Run* ^.* logrequest 

	#SetEnvIf ^X-Run* ^[a-z].* HAVE_XR
	#SetEnvIf Response Content-Type text/html logrequest
	#SetEnvIf Request_URI \.gif image-request
	#SetEnvIf Request_URI \.jpg image-request
	#SetEnvIf Request_URI \.png image-request
	#SetEnvIf Request_URI \.bmp image-request
	#SetEnvIf Request_URI \.css image-request
	SetEnvIf Request_URI \.js image-request
	SetEnvIf Request_URI ^/favicon\.ico image-request
	SetEnvIf Request_URI ^/robots\.txt image-request
	SetEnvIf Request_URI ^/cache image-request
	SetEnvIf Request_URI ^/ckeditor image-request
	SetEnvIf Request_URI ^/flash image-request
	SetEnvIf Request_URI ^/images image-request
	SetEnvIf Request_URI ^/javascripts image-request
	SetEnvIf Request_URI ^/skins image-request
	SetEnvIf Request_URI ^/storage image-request
	SetEnvIf Request_URI ^/ttf image-request


        LogFormat    "%{X-PortalId}o\t%B\t%D\t%>s\t%{X-UserId}o\t%{X-Controller}o\t%{X-Action}o\t%{X-ModelId}o\t%{X-SessionId}o\t%{X-VisitorId}o\t%{X-AbTreatment}o\t%{X-AdsShown}o\t%{X-Runtime}o\t%h\t%l\t%tÂºt\"%r\"\t%b\t\"%{Referer}i\"\t\"%{User-agent}i\"" gm
        CustomLog    "|/usr/local/hosting/bin/rotatelogs /srv/www/gamersmafia/current/log/access-%Y%m%d%H%M.log 86400" gm env=!image-request
        #CustomLog    "|/usr/local/hosting/bin/rotatelogs /srv/www/gamersmafia/current/log/non.rails.access-%Y%m%d%H%M.log 86400" gm env=!notmodified&image-request

	# LOGGING
	#LogFormat    "%B %D %{X-UserId}i %{X-Controller} %{X-Action} %{X-ModelId} %{X-PortalId} %{X-SessionId} %{X-VisitorId} %{X-AbTreatment} %{X-AdsShown} %h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-agent}i\"" gm
	#CustomLog    /dev/null gm
	# CustomLog    "|/usr/local/hosting/bin/rotatelogs /var/log/apache/gamersmafia.com/main_access-%Y%m%d.log 86400" gm
	#LogLevel notice
	ErrorLog "|/usr/local/hosting/bin/rotatelogs /var/log/apache/gamersmafia.com/error-%Y%m%d.log 86400"

	# CACHE CONTROL
	ExpiresActive On
	expiresbytype image/gif A9592000
	expiresbytype image/jpeg A9592000
	expiresbytype image/jpg A9592000
	expiresbytype image/png A9592000
	expiresbytype image/x-icon A9592000
	expiresbytype text/css A9592000
	expiresbytype text/javascript A9592000
	expiresbytype application/javascript A9592000
	expiresbytype application/x-shockwave-flash A9592000
	
	<FilesMatch "\.(gif|jpe?g|png|ico|css|js|swf)$">
		Header set Cache-Control "public"
	</FilesMatch>

	<FilesMatch "channels">
		ExpiresDefault "access plus 10 years"
	</FilesMatch>


	# MOD_REWRITE
	RewriteRule ^/_celements/(.*)$         http://gamersmafia.com/storage/_celements/$1 [L,R=301]

	# Redirigimos todos los dominios que empiecen por www.
	RewriteCond %{HTTP_HOST}   !^gamersmafia\.com [NC]
	RewriteRule ^/miembros(.*)         http://gamersmafia.com/miembros$1 [L,R=301]

	RewriteCond %{HTTP_HOST}   ^www\.(.+) [NC]
	RewriteRule ^(.*)          http://%1$1 [L,R=301]

	RewriteCond %{HTTP_HOST}   !^gamersmafia\.com [NC]
	RewriteRule ^blogs(.*)     http://gamersmafia.com/blogs$1 [L,R=301]

	RewriteCond %{HTTP_HOST}   ^ut3\.es [NC]
	RewriteRule ^(.*)          http://ut3.gamersmafia.com$1 [L,R=301]

	RewriteCond %{HTTP_HOST}  ^d3-esp\.com
	RewriteRule ^(.*)         http://diablo.gamersmafia.com$1 [L,R=301]

	RewriteCond %{HTTP_HOST}  ^4coders\.net
	RewriteRule ^(.*)         http://cod.gamersmafia.com$1 [L,R=301]

	RewriteCond %{HTTP_HOST}  ^4quakers\.com
	RewriteRule ^(.*)         http://quake.gamersmafia.com$1 [L,R=301]

	RewriteCond %{HTTP_HOST}  ^4unrealers\.com
	RewriteRule ^(.*)         http://unreal.gamersmafia.com$1 [L,R=301]

	RewriteCond %{HTTP_HOST}  ^4mohers\.com
	RewriteRule ^(.*)         http://moh.gamersmafia.com$1 [L,R=301,E=REDIRECTED:4mohers.com]

	RewriteCond %{HTTP_HOST}  ^dowforever\.com
	RewriteRule ^(.*)         http://dow.gamersmafia.com$1 [L,R=301]

	RewriteCond %{HTTP_HOST}  ^4americasarmy\.com
	RewriteRule ^(.*)         http://aa.gamersmafia.com$1 [L,R=301]

	RewriteCond %{HTTP_HOST}  ^4doomers\.net
	RewriteRule ^(.*)         http://d3.gamersmafia.com$1 [L,R=301]

	RewriteCond %{HTTP_HOST}  ^4ragnarok\.com
	RewriteRule ^(.*)         http://ro.gamersmafia.com$1 [L,R=301]

	RewriteCond %{HTTP_HOST}  ^4soldiers\.net
	RewriteRule ^(.*)         http://sof2.gamersmafia.com$1 [L,R=301]

	RewriteCond %{HTTP_HOST}  ^4warcraft\.com
	RewriteRule ^(.*)         http://wow.gamersmafia.com$1 [L,R=301]

	RewriteCond %{HTTP_HOST}  ^battlefieldspain\.com
	RewriteRule ^(.*)         http://bf2.gamersmafia.com$1 [L,R=301]

	RewriteCond %{HTTP_HOST}  ^bf1942spain\.com
	RewriteRule ^(.*)         http://bf2.gamersmafia.com$1 [L,R=301]

	RewriteCond %{HTTP_HOST}  ^defuseit\.com
	RewriteRule ^(.*)         http://cs.gamersmafia.com$1 [L,R=301]

	RewriteCond %{HTTP_HOST}  ^sc2-esp\.net
	RewriteRule ^(.*)         http://sc2.gamersmafia.com$1 [L,R=301]

	RewriteCond %{HTTP_HOST}  ^quakereligion\.com
	RewriteRule ^(.*)         http://quake.gamersmafia.com$1 [L,R=301]


	RewriteCond %{HTTP_HOST}   ^gamersmafia\.(net|org|es|info) [NC,OR]
	RewriteCond %{HTTP_HOST}   ^gamersblogs\.net [NC]
	RewriteRule ^(.*)         http://gamersmafia.com$1 [L,R=301]

	RewriteRule ^noticias_eventos(.*)         /coverages%1 [L,R=301]
	RewriteRule ^/offtopics(.*)         http://bazar.gamersmafia.com/noticias [L,R=301]

	RewriteRule ^/d/(.+)$          /storage/d/$1 [L,R=302]

	RewriteCond %{REQUEST_FILENAME} /storage/downloads/(.*)$ [NC]
	RewriteRule ^.*$          /descargas [L,R=301]

	<Directory "/srv/www/gamersmafia/current/public/storage/downloads">
		ForceType application/octet-stream 
		Header set Content-Disposition attachment
	</Directory>

	RewriteCond %{REQUEST_FILENAME} /descargas/download/([0-9]+)$ [NC]
	RewriteCond %{HTTP_REFERER} !^$ 
	RewriteCond %{HTTP_REFERER} !gamersmafia\.com [NC] 
	RewriteRule ^/descargas/download/([0-9]+)$          /descargas/show/$1 [L,R=301]


	RewriteRule ^(.*\.)[0-9a-zA-Z]{7}\.(css|js|gif|png|jpg)$	/$1$2	[L]
	RewriteRule ^(.*\.)[0-9]+\.(css|js|gif|png|jpg)$	/$1$2	[L]

	# shortcut 404 of assets 
	# NO ACTIVAR
	#RewriteCond %{DOCUMENT_ROOT}/%{REQUEST_FILENAME} !-f
	#RewriteRule ^(.*)(css|js)$ / [R=404,L]

	# redirect urls containing other hosts
	RewriteCond %{DOCUMENT_ROOT}/%{REQUEST_FILENAME} !-f
	RewriteRule ^(.*)/(www\.)*([a-z0-9]+)\.(com|net|org|es+)$ http://$2$3.$4/ [R=301,L]
</VirtualHost>
